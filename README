---
ABOUT
---

Shuts the garage door when it's left open too long or when it's open and nobody
is home.

Monitors wireless clients connected to an Airport to determine who's home.
Sends an alert via xmpp (i.e. Google hangouts) with a timeout before attempting
to close the door. 

Shuts the door using an Pololu Micro Maestro server controller to drive the
server to hit a button.

Determines if the door is open using an Arduino with an HC-SR04 rangefinder and
ethernet shield. See doorsensor/arduino_sensor_server/ for more details.

Tested on raspian 7 (wheezy) and Ubuntu 12.04 (Precise).

---
DEPENDENCIES
---

  # Install debian binary deps.
  sudo apt-get install build-essential python-dev
  sudo apt-get install python-virtualenv
  sudo apt-get install libsnmp-python

  # Setup virtualenv and install python modules.
  cd gdoormon  # or whichever dir this README file lives
  virtualenv --system-site-packages deps
  source deps/bin/activate
  pip install -r requirements.txt

  # Or use these if you're not using virtualenv:
  # Comes from pip/requirements.txt:
  #sudo apt-get install wokkel          # also installs twisted
  #sudo apt-get install python-mox      # for tests
  #sudo apt-get install python-openssl  # for xmpp
  # Added as git submodule, not needed:
  #wget https://github.com/oxplot/fysom/blob/master/fysom.py

---
TESTING
---

Run these after install deps to verify everything is working:

  # Verify code compiles, deps are satisifed, etc.
  ./unittest.sh
  # Verify airport connectivity.
  deps/bin/twistd -ny testing/presence_regtest.py 
  # Verify the servo controller works:
  deps/bin/twistd -ny testing/maestro_regtest.py

---
CONFIGURE AND START THE SERVER
---

Edit example.confg and update values as appropriate. Run the server (see
start.sh). Connect to the server in your browser using your phone and
register your phone.

If you want to start it on boot: 
  If your distro uses systemd:
    - copy gdoormon.service to /etc/systemd/system
  else:
    - edit /etc/rc.local to call gdoormonctl.sh
    - edit /etc/logrotate.conf to clean up logs



---
CODE LAYOUT:
---

  doorcontrol/
    - modules for controlling the door
  doorsensor/
    - modules for detecting if the door is open
  presence/
    - modules for detecting if someone is home
  services/
    - twisted modules for services
  state/
    - state machine logic
  xmpp/
    - xmpp communication



---
TODO:
---
  - reformat this file using markdown
  - fix snooze? give help.
  - ask for state using chat
  - timeout approaching warning
  - subscribe to:
    - when registered clients connect/disconnect
    - when nobody/somebody is home
    - when the door changes state
  - add a "manual-only" mode that requires a human
  - needs a way to start the server on boot
  - pylint script
  - broadcast who comes home and last person who left; register name when
    registering. default to "user1", "user2", etc.
  - support dd-wrt/airport interchangeably 
  - support irc
  - drop arduino, use gpio
  - drop pololu+servo, use a relay

vim: set ft=markdown
